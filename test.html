<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>âš¡ï¸é­”æ³•è½‰é‹ç«™ v8.7</title>
    <style>
        :root { --primary: #1abc9c; --primary-dark: #16a085; --danger: #e74c3c; --bg: #f4f9f4; --card-bg: #ffffff; --text: #2c3e50; --text-sec: #7f8c8d; --border: #ccd6d6; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; display: flex; flex-direction: column; align-items: center; -webkit-tap-highlight-color: transparent; }
        .container { width: 100%; max-width: 650px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 18px; box-shadow: 0 5px 25px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.02); }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        h2 { font-size: 1.2rem; margin: 0; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        #pasteBtn { background: #e8f8f5; color: var(--primary); border: 1.5px solid var(--primary); padding: 8px 15px; border-radius: 10px; font-weight: 600; font-size: 13px; cursor: pointer; }
        textarea { width: 100%; height: 160px; border: 2px solid #edf2f2; border-radius: 15px; padding: 12px; font-size: 15px; box-sizing: border-box; resize: none; background: #fdfdfd; line-height: 1.5; outline: none; }
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        .btn-group { position: relative; width: 100%; }
        button { width: 100%; padding: 12px 8px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 13px; min-height: 44px; }
        .full-copy-btn { background: var(--primary); color: white; }
        .clear-btn { background: #f1f3f4; color: var(--text-sec); }
        .btn-msg { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 11px; color: var(--primary); font-weight: bold; opacity: 0; transition: 0.3s; white-space: nowrap; }

        .item-wrapper { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid #f1f1f1; }
        .item-action-bar { display: flex; justify-content: flex-end; align-items: center; gap: 8px; margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .mini-btn { padding: 4px 10px; font-size: 11px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; }

        table { border-collapse: collapse; width: 100%; font-size: 13px; margin: 10px 0; border: 1px solid var(--border); }
        th, td { border: 1px solid var(--border); padding: 10px; text-align: left; }
        th { background-color: #f2f5f5; font-weight: 700; }
        
        .stash-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; border-left: 5px solid var(--primary); box-shadow: 0 3px 10px rgba(0,0,0,0.03); position: relative; }
        .stash-title-input { width: 80%; border: none; border-bottom: 1px solid #eee; font-size: 13px; font-weight: 700; color: var(--primary); margin-bottom: 10px; padding: 5px 0; outline: none; background: transparent; }
        .stash-content-editable { font-size: 14px; line-height: 1.6; outline: none; padding: 5px; min-height: 20px; }
        .stash-footer { display: flex; justify-content: flex-end; align-items: center; margin-top: 10px; border-top: 1px solid #f9f9f9; padding-top: 8px; gap: 8px; }
        
        .inline-msg { font-size: 11px; color: var(--primary); font-weight: bold; opacity: 0; transition: 0.3s; pointer-events: none; }
        .show-msg { opacity: 1; }
        .del-btn { position: absolute; top: 12px; right: 12px; color: #ccc; cursor: pointer; font-size: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="header-row">
            <h2>âš¡ï¸é­”æ³•è½‰é‹ç«™ v8.7</h2>
            <div style="display:flex; align-items:center; gap:10px;">
                <span id="msg-top" class="inline-msg">ğŸ¾ ä½ çš„è­·æ³•å·²ç¾èº«</span>
                <button id="pasteBtn" onclick="pasteFromClipboard()">ğŸ’¡ ç–¾ç–¾ è­·æ³•ç¾èº«</button>
            </div>
        </div>
        <textarea id="input" placeholder="è²¼ä¸Šå’’èªå…§å®¹..."></textarea>
        <div class="btn-grid">
            <div class="btn-group">
                <button class="full-copy-btn" onclick="copyFullPreview(this)">âœ¨ è¶…å¼·åŠ›é›™é›™è£½</button>
                <span class="btn-msg">âœ… è¶…å¼·åŠ›é›™é›™è£½å¤§æˆåŠŸï¼</span>
            </div>
            <div class="btn-group">
                <button class="clear-btn" onclick="clearInput()">ğŸ§¹ ç©ºç©ºéºå¿˜</button>
            </div>
        </div>
    </div>
    <div id="outputArea"></div>
    <div class="stash-header" style="display:flex; justify-content:space-between; align-items:center; width:100%; margin:20px 0 10px;">
        <h3 style="margin:0; color:var(--text-sec); font-size: 1rem;">ğŸ“šï¸ éœæ ¼è¯èŒ²åœ–æ›¸é¤¨</h3>
        <div style="display:flex; align-items:center; gap:10px;">
            <span id="msg-stash-all" class="inline-msg">âœ… è¶…å¼·åŠ›é›™é›™è£½å¤§æˆåŠŸï¼</span>
            <button onclick="copyAllStash(this)" style="background:var(--primary); color:white; padding:8px 12px; border-radius:10px;">âœ¨ è¶…å¼·åŠ›é›™é›™è£½</button>
            <button onclick="clearAllStash()" style="background:#fff; color:var(--danger); border:1px solid #fee; padding:8px 12px; border-radius:10px;">ğŸ§¹ ç©ºç©ºéºå¿˜</button>
        </div>
    </div>
    <div id="stashContainer"></div>
</div>

<script>
    const STORAGE_KEY = 'commander_magic_vault_v8_7';
    let stash = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    window.onload = () => renderStash();

    function triggerMsg(target) {
        if (target) { target.classList.add('show-msg'); setTimeout(() => target.classList.remove('show-msg'), 2000); }
    }

    async function pasteFromClipboard() {
        try {
            const text = await navigator.clipboard.readText();
            document.getElementById('input').value = text;
            processAll(); triggerMsg(document.getElementById('msg-top'));
        } catch (err) { 
            if(document.getElementById('input').value) { processAll(); triggerMsg(document.getElementById('msg-top')); }
        }
    }

    function clearInput() { document.getElementById('input').value = ""; document.getElementById('outputArea').innerHTML = ""; }

    function processAll() {
        const raw = document.getElementById('input').value;
        const output = document.getElementById('outputArea');
        output.innerHTML = ""; if(!raw.trim()) return;
        
        const lines = raw.split(/\n/);
        let tempTable = []; let tempText = [];

        const flushText = () => { if (tempText.length > 0) { renderItem(tempText.join('\n'), output, 'text'); tempText = []; } };
        const flushTable = () => { if (tempTable.length > 0) { renderItem(tempTable, output, 'table'); tempTable = []; } };

        lines.forEach(line => {
            const trimmed = line.trim();
            const pipeCells = line.split('|').filter((c, i, a) => i > 0 && i < a.length - 1);
            const tabCells = line.split('\t');
            
            const isMarkdownTable = line.includes('|') && pipeCells.length >= 2;
            const isTabTable = line.includes('\t') && tabCells.length >= 2;
            const isDivider = line.match(/^[| \-:]+$/);

            if ((isMarkdownTable || isTabTable) && !isDivider && trimmed !== "") {
                flushText();
                tempTable.push(isTabTable ? tabCells.map(c => c.trim()) : pipeCells.map(c => c.trim()));
            } else {
                if (trimmed === "") { flushTable(); flushText(); }
                else { flushTable(); tempText.push(line); }
            }
        });
        flushTable(); flushText();
    }

    function renderItem(data, cont, type) {
        const wrapper = document.createElement('div');
        wrapper.className = "item-wrapper";
        wrapper.innerHTML = `<div class="item-action-bar"><span class="inline-msg">æƒ¡ä½œåŠ‡å®Œæˆâœ…</span><button class="mini-btn" style="background:#f0f0f0;" onclick="copyDirect(this)">ğŸ“‹ é›™é›™è£½</button><button class="mini-btn" style="background:#e8f8f5; color:var(--primary); border:1.5px solid var(--primary);" onclick="stashThis(this)">ğŸ“© æº«å’–ç™²å•¦å”¯å•Šè–©</button></div><div class="pure-content"></div>`;
        const contentDiv = wrapper.querySelector('.pure-content');
        if (type === 'table') {
            const t = document.createElement('table');
            data.forEach((row, rIdx) => {
                const tr = document.createElement('tr');
                row.forEach(cell => { const el = document.createElement(rIdx === 0 ? 'th' : 'td'); el.innerText = cell; tr.appendChild(el); });
                t.appendChild(tr);
            });
            contentDiv.appendChild(t);
        } else {
            const p = document.createElement('div'); p.style.whiteSpace="pre-wrap"; p.innerText = data;
            contentDiv.appendChild(p);
        }
        cont.appendChild(wrapper);
    }

    function stashThis(btn) {
        const contentHTML = btn.closest('.item-wrapper').querySelector('.pure-content').innerHTML;
        stash.push({ title: `#${stash.length + 1}`, html: contentHTML });
        saveStash(); renderStash(); triggerMsg(btn.parentElement.querySelector('.inline-msg'));
    }

    function renderStash() {
        const cont = document.getElementById('stashContainer');
        cont.innerHTML = stash.map((item, i) => `
            <div class="stash-card" data-index="${i}">
                <span class="del-btn" onclick="deleteStash(${i})">&times;</span>
                <input type="text" class="stash-title-input" value="${item.title}" onchange="updateStash(${i})">
                <div class="stash-content-editable" contenteditable="true" oninput="updateStash(${i})">${item.html}</div>
                <div class="stash-footer">
                    <span class="inline-msg">æƒ¡ä½œåŠ‡å®Œæˆâœ…</span>
                    <button class="mini-btn" style="background:#eee;" onclick="copyStashDirect(${i}, this)">ğŸ“‹ é›™é›™è£½</button>
                    <button class="mini-btn" style="background:var(--primary); color:white;" onclick="saveManual(${i}, this)">ğŸ’¾ O.W.L.säº¤å·</button>
                </div>
            </div>
        `).join('');
    }

    function updateStash(idx) {
        const card = document.querySelector(`.stash-card[data-index="${idx}"]`);
        if(card) {
            stash[idx].title = card.querySelector('.stash-title-input').value;
            stash[idx].html = card.querySelector('.stash-content-editable').innerHTML;
            saveStash();
        }
    }

    function saveManual(idx, btn) { updateStash(idx); triggerMsg(btn.parentElement.querySelector('.inline-msg')); }
    function deleteStash(idx) { if(confirm("ç¢ºå®šè¦åˆªé™¤ï¼Ÿ")) { stash.splice(idx, 1); saveStash(); renderStash(); } }
    function saveStash() { localStorage.setItem(STORAGE_KEY, JSON.stringify(stash)); }
    function clearAllStash() { if(confirm("ç¢ºå®šå…¨éƒ¨æ¸…é™¤ï¼Ÿ")) { stash = []; saveStash(); renderStash(); } }

    function executeNativeCopy(htmlContent, title = "") {
        const temp = document.createElement('div');
        temp.style.position = 'fixed'; temp.style.left = '-9999px';
        if(title) { temp.innerHTML += `<h3 style="color:#1abc9c">${title}</h3>`; }
        temp.innerHTML += htmlContent;
        document.body.appendChild(temp);
        
        const range = document.createRange();
        range.selectNodeContents(temp);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        document.execCommand('copy');
        document.body.removeChild(temp);
    }

    function copyDirect(btn) { 
        executeNativeCopy(btn.closest('.item-wrapper').querySelector('.pure-content').innerHTML); 
        triggerMsg(btn.parentElement.querySelector('.inline-msg')); 
    }

    function copyStashDirect(idx, btn) {
        updateStash(idx);
        const content = document.querySelector(`.stash-card[data-index="${idx}"] .stash-content-editable`).innerHTML;
        executeNativeCopy(content, stash[idx].title);
        triggerMsg(btn.parentElement.querySelector('.inline-msg'));
    }

    function copyFullPreview(btn) {
        let fullHTML = "";
        document.querySelectorAll('#outputArea .pure-content').forEach(c => fullHTML += c.innerHTML + "<br>");
        executeNativeCopy(fullHTML);
        triggerMsg(btn.parentElement.querySelector('.btn-msg'));
    }

    function copyAllStash(btn) {
        if(stash.length === 0) return;
        let allHTML = "";
        stash.forEach(item => { allHTML += `<h3 style="color:#1abc9c">${item.title}</h3>${item.html}<br><br>`; });
        executeNativeCopy(allHTML);
        triggerMsg(document.getElementById('msg-stash-all'));
    }
</script>
</body>
</html>
