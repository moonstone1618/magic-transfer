<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline'; object-src 'none';">
    <title>âš¡ï¸é­”æ³•è½‰é‹ç«™</title>
    <style>
        :root { --primary: #1abc9c; --primary-dark: #16a085; --danger: #e74c3c; --bg: #f4f9f4; --card-bg: #ffffff; --text: #2c3e50; --text-sec: #7f8c8d; --border: #ccd6d6; }
        
        /* åŸºç¤æ’ç‰ˆ */
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 650px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 18px; box-shadow: 0 5px 25px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.02); }
        
        /* 1. æ¨™é¡Œå€å¡Šï¼šä¸Šä¸‹çµæ§‹ + å·¦å³æ¥µç«¯å°ç¨± */
        .header-row, .stash-header { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: space-between; 
            align-items: flex-end; 
            margin-bottom: 12px; 
        }
        h2, h3 { 
            flex: 1 0 100%; /* å¼·åˆ¶æ¨™é¡Œä½”æ»¿ä¸Šæ–¹ä¸€è¡Œ */
            font-size: 1.2rem; 
            margin: 0 0 10px 0; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        /* è®“è£è¼‰ã€Œè²¼ä¸ŠæŒ‰éˆ•ã€æˆ–ã€Œåœ–æ›¸é¤¨æ§åˆ¶éˆ•ã€å¼·åˆ¶é å³ */
        .header-row > div, .stash-header > div { 
            width: 100%; 
            display: flex; 
            justify-content: flex-end; 
            align-items: center; 
            gap: 12px; 
        }
    
        #pasteBtn { background: #e8f8f5; color: var(--primary); border: 1.5px solid var(--primary); padding: 8px 15px; border-radius: 10px; font-weight: 600; font-size: 13px; cursor: pointer; white-space: nowrap; }
        textarea { width: 100%; height: 160px; border: 2px solid #edf2f2; border-radius: 15px; padding: 12px; font-size: 14px; box-sizing: border-box; resize: none; background: #fdfdfd; line-height: 1.5; outline: none; }
        
        /* 2. ä¸»è¦æŒ‰éˆ•ï¼šéå°ç¨±ä¸¦æ’ (å·¦å¯¬å³çª„) */
        .btn-grid { 
            display: grid; 
            grid-template-columns: 1.8fr 1fr; /* çµ¦äºˆè¶…å¼·åŠ›é›™é›™è£½æ›´å¤šç©ºé–“ */
            gap: 8px; 
            margin-top: 15px; 
            align-items: center; 
        }
        button { padding: 12px 8px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 13px; }
        .full-copy-btn { background: var(--primary); color: white; }
        .clear-btn { background: #f1f3f4; color: var(--text-sec); }
    
        /* åŠŸèƒ½æ¨£å¼ */
        .item-wrapper { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid #f1f1f1; }
        .item-action-bar { display: flex; justify-content: flex-end; align-items: center; gap: 8px; margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .mini-btn { padding: 4px 10px; font-size: 11px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; }
        table { border-collapse: collapse; width: 100%; font-size: 13px; margin: 5px 0; border: 1px solid var(--border); background-color: white; }
        th, td { border: 1px solid var(--border); padding: 10px; text-align: left; }
        th { background-color: #f2f5f5 !important; color: #34495e; font-weight: 700; }
        .stash-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; border-left: 5px solid var(--primary); box-shadow: 0 3px 10px rgba(0,0,0,0.03); position: relative; }
        .stash-title-input { width: 80%; border: none; border-bottom: 1px solid #eee; font-size: 13px; font-weight: 700; color: var(--primary); margin-bottom: 10px; padding: 5px 0; outline: none; background: transparent; }
        .stash-content-editable { font-size: 14px; line-height: 1.6; outline: none; padding: 5px; min-height: 20px; background-color: white; }
        .stash-footer { display: flex; justify-content: flex-end; align-items: center; margin-top: 10px; border-top: 1px solid #f9f9f9; padding-top: 8px; gap: 8px; }
        .inline-msg { font-size: 11px; color: var(--primary); font-weight: bold; opacity: 0; transition: 0.3s; pointer-events: none; }
        .show-msg { opacity: 1; }
        .del-btn { position: absolute; top: 12px; right: 12px; color: #ccc; cursor: pointer; font-size: 20px; }
    </style>
    
</head>
<body>

<div class="container">
    <div class="card">
        <div class="header-row">
            <h2>âš¡ï¸é­”æ³•è½‰é‹ç«™</h2>
            <div style="display:flex; align-items:center; gap:10px;">
                <span id="msg-top" class="inline-msg">ğŸ¾ä½ çš„è­·æ³•å·²ç¾èº«</span>
                <button id="pasteBtn" onclick="pasteFromClipboard()">ğŸ’¡ç–¾ç–¾ è­·æ³•ç¾èº«</button>
            </div>
        </div>
        <textarea id="input" placeholder="contenté€Ÿé€Ÿå‰ğŸŒŸ"></textarea>
        <div class="btn-grid">
            <div style="display:flex; align-items:center; gap:8px;">
                <button class="full-copy-btn" onclick="copyFullPreview(this)">âœ¨è¶…å¼·åŠ›é›™é›™è£½</button>
                <span class="inline-msg">âœ…</span>
            </div>
            <button class="clear-btn" onclick="clearInput()">ğŸ§¹ç©ºç©ºéºå¿˜</button>
        </div>
    </div>

    <div id="outputArea"></div>

    <div class="stash-header" style="display:flex; justify-content:space-between; align-items:center; width:100%; margin:20px 0 10px;">
        <h3 style="margin:0; color:var(--text-sec); font-size: 1.2rem;">ğŸ“šï¸éœæ ¼è¯èŒ²åœ–æ›¸é¤¨</h3>
        <div style="display:flex; align-items:center; gap:12px;">
            <span id="msg-stash-all" class="inline-msg">âœ…</span>
            <button onclick="copyAllStash(this)" style="background:var(--primary); color:white; padding:8px 12px; border-radius:10px; cursor:pointer; border:none; font-weight:600;">âœ¨è¶…å¼·åŠ›é›™é›™è£½</button>
            <button onclick="clearAllStash()" style="background:#fff; color:var(--danger); border:1px solid #fee; padding:8px 12px; border-radius:10px; cursor:pointer;">ğŸ§¹ç©ºç©ºéºå¿˜</button>
        </div>
    </div>
    <div id="stashContainer"></div>
</div>

<script>
    let stash = JSON.parse(localStorage.getItem('commander_stash_v8_0') || '[]');
    window.onload = () => renderStash();

    // é—œéµé˜²ç¦¦å‡½æ•¸ï¼šç§»é™¤æ‰€æœ‰å±éšªæ¨™ç±¤èˆ‡ JavaScript å±¬æ€§
    function sanitize(html) {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        // ç§»é™¤æ‰€æœ‰ script æ¨™ç±¤
        const scripts = doc.querySelectorAll('script, iframe, object, embed');
        scripts.forEach(s => s.remove());
        // ç§»é™¤æ‰€æœ‰æ¨™ç±¤ä¸Šçš„ on... å±¬æ€§ (å¦‚ onerror, onclick)
        const allElements = doc.querySelectorAll('*');
        allElements.forEach(el => {
            const attrs = el.attributes;
            for (let i = attrs.length - 1; i >= 0; i--) {
                const attrName = attrs[i].name.toLowerCase();
                if (attrName.startsWith('on') || attrs[i].value.includes('javascript:')) {
                    el.removeAttribute(attrs[i].name);
                }
            }
        });
        return doc.body.innerHTML;
    }

    function triggerMsg(target) {
        if (target) { target.classList.add('show-msg'); setTimeout(() => target.classList.remove('show-msg'), 2000); }
    }

    async function pasteFromClipboard() {
        try {
            const text = await navigator.clipboard.readText();
            document.getElementById('input').value = text;
            processAll(); triggerMsg(document.getElementById('msg-top'));
        } catch (err) { alert("é€™ä¸æ˜¯éº»ç“œè©²ä¾†çš„ä¸–ç•Œã€€å»å»éº»ç“œèµ°ï¼"); }
    }

    function clearInput() { document.getElementById('input').value = ""; document.getElementById('outputArea').innerHTML = ""; }

    function processAll() {
        const raw = document.getElementById('input').value;
        const output = document.getElementById('outputArea');
        output.innerHTML = ""; if(!raw.trim()) return;
        const lines = raw.split('\n');
        let tempTable = []; let tempText = [];
        const flushText = () => { if (tempText.length > 0) { renderItem(tempText.join('\n'), output, 'text'); tempText = []; } };
        const flushTable = () => { if (tempTable.length > 0) { renderItem(tempTable, output, 'table'); tempTable = []; } };
        lines.forEach(line => {
            const isTableLine = line.includes('|') && line.split('|').length > 2;
            const isDivider = line.match(/^[| \-:]+$/);
            if (isTableLine && !isDivider) { flushText(); const cells = line.split('|').filter((c, i, a) => i > 0 && i < a.length - 1).map(c => c.trim()); tempTable.push(cells); }
            else if (!isDivider) { flushTable(); tempText.push(line); }
        });
        flushTable(); flushText();
    }

    function renderItem(data, cont, type) {
        const wrapper = document.createElement('div');
        wrapper.className = "item-wrapper";
        wrapper.innerHTML = `<div class="item-action-bar"><span class="inline-msg">æƒ¡ä½œåŠ‡å®Œæˆâœ…</span><button class="mini-btn" style="background:#f0f0f0;" onclick="copyDirect(this)">ğŸ“‹é›™é›™è£½</button><button class="mini-btn" style="background:#e8f8f5; color:var(--primary); border:1.5px solid var(--primary);" onclick="stashThis(this)">ğŸ“©æº«å’–ç™²å•¦å”¯å•Šè–©</button></div><div class="pure-content"></div>`;
        const contentDiv = wrapper.querySelector('.pure-content');
        if (type === 'table') {
            const t = document.createElement('table');
            data.forEach((row, rIdx) => {
                const tr = document.createElement('tr');
                row.forEach(cell => { const el = document.createElement(rIdx === 0 ? 'th' : 'td'); el.innerText = cell; tr.appendChild(el); });
                t.appendChild(tr);
            });
            contentDiv.appendChild(t);
        } else {
            const p = document.createElement('div'); p.style.fontSize="14px"; p.style.lineHeight="1.6"; p.style.whiteSpace="pre-wrap"; p.innerText = data;
            contentDiv.appendChild(p);
        }
        cont.appendChild(wrapper);
    }

    function stashThis(btn) {
        // å­˜æª”å‰é€²è¡Œä¸€æ¬¡æ·¨åŒ–
        const contentHTML = sanitize(btn.closest('.item-wrapper').querySelector('.pure-content').innerHTML);
        stash.push({ title: `#${stash.length + 1}`, html: contentHTML });
        saveStash(); renderStash(); triggerMsg(btn.parentElement.querySelector('.inline-msg'));
    }

    function renderStash() {
        const cont = document.getElementById('stashContainer');
        // æ¸²æŸ“æ™‚ç¢ºä¿è¼¸å‡ºå…§å®¹å·²æ·¨åŒ–
        cont.innerHTML = stash.map((item, i) => `
            <div class="stash-card" data-index="${i}">
                <span class="del-btn" onclick="deleteStash(${i})">&times;</span>
                <input type="text" class="stash-title-input" value="${item.title}" onchange="updateStash(${i})">
                <div class="stash-content-editable" contenteditable="true" oninput="updateStash(${i})">${sanitize(item.html)}</div>
                <div class="stash-footer">
                    <span class="inline-msg">æƒ¡ä½œåŠ‡å®Œæˆâœ…</span>
                    <button class="mini-btn" style="background:#eee;" onclick="copyStashDirect(${i}, this)">ğŸ“‹é›™é›™è£½</button>
                    <button class="mini-btn" style="background:var(--primary); color:white;" onclick="saveManual(${i}, this)">ğŸ’¾O.W.L.säº¤å·</button>
                </div>
            </div>
        `).join('');
    }

    function updateStash(idx) {
        const card = document.querySelector(`.stash-card[data-index="${idx}"]`);
        if(card) {
            stash[idx].title = card.querySelector('.stash-title-input').value;
            // æ›´æ–°æ™‚åŒæ¨£æ·¨åŒ–å…§å®¹
            stash[idx].html = sanitize(card.querySelector('.stash-content-editable').innerHTML);
            saveStash();
        }
    }

    function saveManual(idx, btn) { updateStash(idx); triggerMsg(btn.parentElement.querySelector('.inline-msg')); }
    function deleteStash(idx) { stash.splice(idx, 1); saveStash(); renderStash(); }
    function saveStash() { localStorage.setItem('commander_stash_v8_0', JSON.stringify(stash)); }
    function clearAllStash() { if(confirm("ç¢ºå®šè¦ä¸€å¿˜çš†ç©ºï¼Ÿ")) { stash = []; saveStash(); renderStash(); } }

    function copyDirect(btn) { executeNativeCopy(btn.closest('.item-wrapper').querySelector('.pure-content')); triggerMsg(btn.parentElement.querySelector('.inline-msg')); }

    function copyStashDirect(idx, btn) {
        updateStash(idx);
        const el = document.querySelector(`.stash-card[data-index="${idx}"] .stash-content-editable`);
        executeNativeCopy(el);
        triggerMsg(btn.parentElement.querySelector('.inline-msg'));
    }

    function copyFullPreview(btn) {
        const temp = document.createElement('div');
        document.querySelectorAll('#outputArea .pure-content').forEach(c => temp.appendChild(c.cloneNode(true)));
        document.body.appendChild(temp);
        executeNativeCopy(temp);
        document.body.removeChild(temp);
        triggerMsg(btn.parentElement.querySelector('.inline-msg'));
    }

    function copyAllStash(btn) {
        if(stash.length === 0) return;
        const temp = document.createElement('div');
        stash.forEach(item => { temp.innerHTML += `<h3 style="color:#1abc9c">${item.title}</h3>${item.html}<br><br>`; });
        document.body.appendChild(temp);
        executeNativeCopy(temp);
        document.body.removeChild(temp);
        triggerMsg(document.getElementById('msg-stash-all'));
    }

    function executeNativeCopy(el) {
        const originalBg = document.body.style.backgroundColor;
        document.body.style.backgroundColor = "white";
        const range = document.createRange();
        range.selectNodeContents(el);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        document.execCommand('copy');
        sel.removeAllRanges();
        document.body.style.backgroundColor = originalBg;
    }
</script>
</body>
</html>
