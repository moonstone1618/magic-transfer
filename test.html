<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline'; object-src 'none';">
    <title>âš¡ï¸ç–¾ç–¾ è¡¨æ ¼ç¾èº«</title>
    <style>
        :root { 
            --primary: #1abc9c; --primary-dark: #16a085; --danger: #e74c3c; 
            --bg: #f4f9f4; --card-bg: #ffffff; --text: #2c3e50; 
            --text-sec: #7f8c8d; --border: #ccd6d6; --input-bg: #fdfdfd;
        }
        
        /* å‘¼å‘¼å‰å’’ç¾ï¼šæ·±è—æ¨¡å¼æ¨£å¼ */
        body.dark-mode { 
            --primary: #3498db; --primary-dark: #2980b9; 
            --bg: #1a1c2c; --card-bg: #2c2f48; --text: #ecf0f1; 
            --text-sec: #bdc3c7; --border: #444b6e; --input-bg: #1e2132;
        }

        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; display: flex; flex-direction: column; align-items: center; transition: 0.5s; }
        .container { width: 100%; max-width: 650px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 18px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); margin-bottom: 16px; border: 1px solid rgba(0,0,0,0.02); }
        
        .header-row, .stash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        h2, h3 { font-size: 1.2rem; margin: 0; color: var(--primary); display: flex; align-items: center; gap: 8px; }
    
        .mode-toggle-btn { background: #34495e; color: #fff; border: none; padding: 6px 12px; border-radius: 20px; font-size: 11px; cursor: pointer; font-weight: bold; }
        #pasteBtn { background: rgba(26, 188, 156, 0.1); color: var(--primary); border: 1.5px solid var(--primary); padding: 8px 15px; border-radius: 10px; font-weight: 600; font-size: 13px; cursor: pointer; }
        
        /* å¼·åŒ–ç‰ˆè¼¸å…¥å€ï¼šæ”¯æ´å¯Œæ–‡æœ¬è²¼ä¸Š */
        #input { 
            width: 100%; min-height: 160px; max-height: 400px; overflow-y: auto;
            border: 2px solid var(--border); border-radius: 15px; padding: 12px; 
            font-size: 14px; box-sizing: border-box; background: var(--input-bg); 
            color: var(--text); line-height: 1.5; outline: none; transition: 0.3s; white-space: pre-wrap;
        }
        #input:empty:before { content: "è²¼ä¸Šå…§å®¹æ–¼æ­¤..."; color: var(--text-sec); }
        
        .btn-grid { display: grid; grid-template-columns: 1.8fr 1.1fr; gap: 8px; margin-top: 15px; }
        button { padding: 12px 8px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 13px; }
        .full-copy-btn { background: var(--primary); color: white; }
        .clear-btn { background: rgba(0,0,0,0.05); color: var(--danger); }
    
        .item-wrapper { background: var(--card-bg); border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); }
        .item-action-bar { display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 8px; border-bottom: 1px dashed var(--border); padding-bottom: 5px; }
        .mini-btn { padding: 4px 10px; font-size: 11px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; }
        
        table { border-collapse: collapse; width: 100%; font-size: 13px; margin: 5px 0; border: 1px solid var(--border); background: #fff; color: #333; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
        th { background-color: #f2f5f5; font-weight: 700; }
        
        .stash-card { background: var(--card-bg); border-radius: 15px; padding: 15px; margin-bottom: 15px; border-left: 5px solid var(--primary); position: relative; border: 1px solid var(--border); }
        .stash-title-input { width: 80%; border: none; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 700; color: var(--primary); margin-bottom: 10px; padding: 5px 0; outline: none; background: transparent; }
        .stash-content-editable { font-size: 14px; line-height: 1.6; outline: none; padding: 5px; min-height: 20px; }
        .inline-msg { font-size: 11px; color: var(--primary); font-weight: bold; opacity: 0; transition: 0.3s; }
        .show-msg { opacity: 1; }
        .del-btn { position: absolute; top: 12px; right: 12px; color: var(--text-sec); cursor: pointer; font-size: 20px; }
    </style>
</head>
<body id="mainBody">

<div class="container">
    <div class="card">
        <div class="header-row">
            <h2 id="modeTitle">âš¡ï¸ ç–¾ç–¾ è¡¨æ ¼ç¾èº«</h2>
            <button class="mode-toggle-btn" onclick="toggleMode()">ğŸª„ å‘¼å‘¼ å‰å’’ç¾</button>
        </div>
        <div class="header-row">
            <div style="font-size: 12px; color: var(--text-sec);" id="modeDesc">ç›®å‰ï¼šMD è½‰ ä¸€èˆ¬è¡¨æ ¼</div>
            <div>
                <span id="msg-top" class="inline-msg">ğŸ¾</span>
                <button id="pasteBtn" onclick="pasteRichContent()">ğŸ’¡Contenté€Ÿé€Ÿå‰</button>
            </div>
        </div>
        <div id="input" contenteditable="true"></div>
        <div class="btn-grid">
            <div style="display:flex; align-items:center; gap:8px;">
                <button class="full-copy-btn" onclick="copyFullPreview(this)">âœ¨è¶…å¼·åŠ›é›™é›™è£½</button>
                <span class="inline-msg">ğŸ¾</span>
            </div>
            <button class="clear-btn" onclick="clearInput()">ğŸ§¹å»å»é›œäº‚èµ°</button>
        </div>
    </div>

    <div id="outputArea"></div>

    <div class="stash-header">
        <h3 style="margin:0; color:var(--primary); font-size: 1.15rem;">ğŸ”® å„²æ€ç›†</h3>
        <div style="display:flex; align-items:center; gap:15px;">
            <span id="msg-stash-all" class="inline-msg">ğŸ¾</span>
            <button onclick="copyAllStash(this)" style="background:var(--primary); color:white; padding:8px 12px; border-radius:10px; cursor:pointer; border:none; font-weight:600;">âœ¨è¶…å¼·åŠ›é›™é›™è£½</button>
            <button onclick="clearAllStash()" style="background:transparent; color:var(--danger); border:1px solid var(--danger); padding:8px 12px; border-radius:10px; cursor:pointer;">ğŸ§¹ç©ºç©ºéºå¿˜</button>
        </div>
    </div>
    <div id="stashContainer"></div>
</div>

<script>
    let stash = JSON.parse(localStorage.getItem('commander_stash_v8_0') || '[]');
    let isReverseMode = false;
    const inputEl = document.getElementById('input');

    window.onload = () => {
        renderStash();
        inputEl.addEventListener('input', processAll);
    };

    // --- æ ¸å¿ƒé‚è¼¯ï¼šé»‘é­”æ³•é˜²ç¦¦è¡“ (è³‡å®‰æ·¨åŒ–) ---
    function sanitize(html) {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        doc.querySelectorAll('script, iframe, object, embed').forEach(s => s.remove());
        doc.querySelectorAll('*').forEach(el => {
            const attrs = el.attributes;
            for (let i = attrs.length - 1; i >= 0; i--) {
                const name = attrs[i].name.toLowerCase();
                if (name.startsWith('on') || attrs[i].value.includes('javascript:')) el.removeAttribute(attrs[i].name);
            }
        });
        return doc.body.innerHTML;
    }

    function toggleMode() {
        isReverseMode = !isReverseMode;
        document.getElementById('mainBody').classList.toggle('dark-mode');
        document.getElementById('modeTitle').innerText = isReverseMode ? "ğŸŒ™ å‘¼å‘¼ å‰å’’ç¾" : "âš¡ï¸ ç–¾ç–¾ è¡¨æ ¼ç¾èº«";
        document.getElementById('modeDesc').innerText = isReverseMode ? "ç›®å‰ï¼šç¶²é è¡¨æ ¼ è½‰ Markdown" : "ç›®å‰ï¼šMD è½‰ ä¸€èˆ¬è¡¨æ ¼";
        processAll();
    }

    // --- æ ¸å¿ƒé‚è¼¯ï¼šè½‰æ›åˆ†æµ ---
    function processAll() {
        const output = document.getElementById('outputArea');
        output.innerHTML = "";
        
        if (isReverseMode) {
            // ã€åå‘é‚è¼¯ã€‘ï¼šå¾ DOM ç¯€é»ä¸­æŠ“å– <table> ä¸¦è½‰ç‚º Markdown
            const tables = inputEl.querySelectorAll('table');
            if (tables.length > 0) {
                let allMd = "";
                tables.forEach(table => {
                    const rows = Array.from(table.querySelectorAll('tr'));
                    rows.forEach((tr, i) => {
                        const cells = Array.from(tr.querySelectorAll('th, td')).map(c => c.innerText.trim().replace(/\|/g, "\\|"));
                        allMd += "| " + cells.join(" | ") + " |\n";
                        if (i === 0) allMd += "| " + cells.map(() => "---").join(" | ") + " |\n";
                    });
                    allMd += "\n";
                });
                renderItem(allMd.trim(), output, 'text');
            }
        } else {
            // ã€æ­£å‘é‚è¼¯ã€‘ï¼šè§£æ Markdown èªæ³•ä¸¦ç¹ªè£½ HTML è¡¨æ ¼
            const raw = inputEl.innerText;
            const lines = raw.split('\n');
            let tempTable = []; let tempText = [];
            
            const flushText = () => { if (tempText.length > 0) { renderItem(tempText.join('\n'), output, 'text'); tempText = []; } };
            const flushTable = () => { if (tempTable.length > 0) { renderItem(tempTable, output, 'table'); tempTable = []; } };
            
            lines.forEach(line => {
                const isTableLine = line.includes('|') && line.split('|').length > 2;
                const isDivider = line.match(/^[| \-:]+$/);
                if (isTableLine && !isDivider) { 
                    flushText(); 
                    const cells = line.split('|').filter((c, i, a) => i > 0 && i < a.length - 1).map(c => c.trim()); 
                    tempTable.push(cells); 
                }
                else if (!isDivider) { flushTable(); tempText.push(line); }
            });
            flushTable(); flushText();
        }
    }

    function renderItem(data, cont, type) {
        const wrapper = document.createElement('div');
        wrapper.className = "item-wrapper";
        wrapper.innerHTML = `<div class="item-action-bar"><span class="inline-msg">æƒ¡ä½œåŠ‡å®ŒæˆğŸ¾</span><button class="mini-btn" style="background:var(--border); color:var(--text);" onclick="copyDirect(this)">ğŸ“‹é›™é›™è£½</button><button class="mini-btn" style="background:var(--primary); color:white;" onclick="stashThis(this)">ğŸ“©æº«å’–ç™²å•¦å”¯å•Šè–©</button></div><div class="pure-content"></div>`;
        const contentDiv = wrapper.querySelector('.pure-content');
        
        if (type === 'table') {
            const t = document.createElement('table');
            data.forEach((row, rIdx) => {
                const tr = document.createElement('tr');
                row.forEach(cell => { const el = document.createElement(rIdx === 0 ? 'th' : 'td'); el.innerText = cell; tr.appendChild(el); });
                t.appendChild(tr);
            });
            contentDiv.appendChild(t);
        } else {
            const p = document.createElement('div'); p.style.whiteSpace="pre-wrap"; p.innerText = data;
            contentDiv.appendChild(p);
        }
        cont.appendChild(wrapper);
    }

    // --- å„²æ€ç›† (Stash) èˆ‡ äº’å‹•é‚è¼¯ ---
    function stashThis(btn) {
        const contentHTML = sanitize(btn.closest('.item-wrapper').querySelector('.pure-content').innerHTML);
        stash.push({ title: `#${stash.length + 1}`, html: contentHTML });
        saveStash(); renderStash(); triggerMsg(btn.parentElement.querySelector('.inline-msg'));
    }

    function renderStash() {
        const cont = document.getElementById('stashContainer');
        cont.innerHTML = stash.map((item, i) => `
            <div class="stash-card" data-index="${i}">
                <span class="del-btn" onclick="deleteStash(${i})">&times;</span>
                <input type="text" class="stash-title-input" value="${item.title}" onchange="updateStash(${i})">
                <div class="stash-content-editable" contenteditable="true" oninput="updateStash(${i})">${sanitize(item.html)}</div>
                <div class="stash-footer">
                    <span class="inline-msg">ğŸ¾</span>
                    <button class="mini-btn" style="background:var(--border);" onclick="copyStashDirect(${i}, this)">ğŸ“‹é›™é›™è£½</button>
                    <button class="mini-btn" style="background:var(--primary); color:white;" onclick="saveManual(${i}, this)">ğŸ’¾äº¤å·</button>
                </div>
            </div>
        `).join('');
    }

    async function pasteRichContent() {
        try {
            const text = await navigator.clipboard.readText();
            inputEl.innerText = text; // é è¨­å…ˆä»¥æ–‡å­—è²¼å…¥ï¼Œè‹¥è¦æ”¯æ´è¤‡é›œ HTML è²¼ä¸Šéœ€æ›´è¤‡é›œè™•ç†
            processAll();
            triggerMsg(document.getElementById('msg-top'));
        } catch (err) { alert("è®€å–å‰ªè²¼ç°¿å¤±æ•—"); }
    }

    function updateStash(idx) {
        const card = document.querySelector(`.stash-card[data-index="${idx}"]`);
        if(card) {
            stash[idx].title = card.querySelector('.stash-title-input').value;
            stash[idx].html = sanitize(card.querySelector('.stash-content-editable').innerHTML);
            saveStash();
        }
    }

    function saveStash() { localStorage.setItem('commander_stash_v8_0', JSON.stringify(stash)); }
    function deleteStash(idx) { stash.splice(idx, 1); saveStash(); renderStash(); }
    function clearAllStash() { if(confirm("ç¢ºå®šè¦ä¸€å¿˜çš†ç©ºï¼Ÿ")) { stash = []; saveStash(); renderStash(); } }
    function clearInput() { inputEl.innerHTML = ""; document.getElementById('outputArea').innerHTML = ""; }
    function triggerMsg(target) { if (target) { target.classList.add('show-msg'); setTimeout(() => target.classList.remove('show-msg'), 2000); } }
    function saveManual(idx, btn) { updateStash(idx); triggerMsg(btn.parentElement.querySelector('.inline-msg')); }
    
    function executeNativeCopy(el) {
        const range = document.createRange(); range.selectNodeContents(el);
        const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
        document.execCommand('copy'); sel.removeAllRanges();
    }

    function copyDirect(btn) { executeNativeCopy(btn.closest('.item-wrapper').querySelector('.pure-content')); triggerMsg(btn.parentElement.querySelector('.inline-msg')); }
    function copyStashDirect(idx, btn) { updateStash(idx); executeNativeCopy(document.querySelector(`.stash-card[data-index="${idx}"] .stash-content-editable`)); triggerMsg(btn.parentElement.querySelector('.inline-msg')); }
    function copyFullPreview(btn) { const temp = document.createElement('div'); document.querySelectorAll('#outputArea .pure-content').forEach(c => temp.appendChild(c.cloneNode(true))); document.body.appendChild(temp); executeNativeCopy(temp); document.body.removeChild(temp); triggerMsg(btn.parentElement.querySelector('.inline-msg')); }
    function copyAllStash(btn) { if(stash.length === 0) return; const temp = document.createElement('div'); stash.forEach(item => { temp.innerHTML += `<h3>${item.title}</h3>${item.html}<br><br>`; }); document.body.appendChild(temp); executeNativeCopy(temp); document.body.removeChild(temp); triggerMsg(document.getElementById('msg-stash-all')); }
</script>
</body>
</html>
